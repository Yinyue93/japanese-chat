<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ  - Japanese Chat</title>
    <link rel="stylesheet" href="/output.css">
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        .messages-container {
            height: calc(100vh - 400px);
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }
        .messages-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .messages-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        .messages-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-50 min-h-screen">
    <!-- Notification Sound -->
    <audio id="notificationSound" preload="auto">
        <source src="/sounds/sound.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <div class="container mx-auto px-4 py-4 max-w-4xl">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 id="roomName" class="text-2xl font-bold text-gray-800">ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </h1>
                    <p class="text-gray-600">å‚åŠ è€…: <span id="userCount" class="font-semibold text-indigo-600">0</span>äºº</p>
                </div>
                <button id="leaveRoomBtn" 
                        class="bg-gradient-to-r from-red-500 to-pink-600 text-white px-6 py-3 rounded-xl font-medium hover:from-red-600 hover:to-pink-700 transform transition-all duration-200 hover:scale-105 focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                    é€€å®¤
                </button>
            </div>
        </div>
        
        <!-- Chat Messages -->
        <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
            <div id="messagesContainer" class="messages-container space-y-3 mb-4" style="min-height: 400px;">
                <div id="noMessages" class="text-center py-12">
                    <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"></path>
                        <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"></path>
                    </svg>
                    <p class="text-gray-500 text-lg">ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    <p class="text-gray-400 text-sm mt-2">æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
                </div>
            </div>
            
            <!-- Typing Indicator -->
            <div id="typingIndicator" class="mb-4" style="display: none;">
                <div class="flex items-center space-x-2 text-gray-600 text-sm">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms;"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms;"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms;"></div>
                    </div>
                    <span id="typingText">å…¥åŠ›ä¸­...</span>
                </div>
            </div>
            
            <!-- Message Input -->
            <div class="border-t border-gray-200 pt-4">
                <form id="messageForm" class="flex space-x-4">
                    <input type="text" 
                           id="messageInput" 
                           placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„... (ç”»åƒã‚‚è²¼ã‚Šä»˜ã‘ã§ãã¾ã™)" 
                           maxlength="500"
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 text-gray-800"
                           autocomplete="off">
                    <button type="submit" 
                            class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-6 py-3 rounded-xl font-medium hover:from-indigo-600 hover:to-purple-700 transform transition-all duration-200 hover:scale-105 focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        é€ä¿¡
                    </button>
                </form>
                <p class="text-xs text-gray-500 mt-2">æœ€å¤§500æ–‡å­—ã¾ã§ â€¢ ç”»åƒã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰Ctrl+Vï¼ˆCmd+Vï¼‰ã§è²¼ã‚Šä»˜ã‘ã§ãã¾ã™ï¼ˆ5MBä»¥ä¸‹ï¼‰</p>
            </div>
        </div>
        
        <!-- User List -->
        <div id="userList" class="bg-white rounded-2xl shadow-lg p-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">å‚åŠ è€…ä¸€è¦§</h3>
            <div id="userListContent" class="flex flex-wrap gap-2">
                <!-- Users will be listed here -->
            </div>
        </div>
    </div>
    
    <script>
        const socket = io();
        const username = localStorage.getItem('username');
        const roomId = window.location.pathname.split('/')[2];
        
        if (!username || !roomId) {
            window.location.href = '/lounge';
        }
        
        let userCount = 0;
        let typingUsers = new Set();
        let isTyping = false;
        let typingTimeout;
        
        // Image upload functionality
        let isUploadingImage = false;
        

        
        // Join the room directly - server will handle validation
        console.log('Attempting to join room:', { roomId, username });
        socket.emit('join-room', { roomId, username });
        
        // Add timeout to detect if room join fails  
        setTimeout(() => {
            if (document.getElementById('roomName').textContent === 'ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ') {
                console.error('Room join may have failed - room name not updated');
                alert('éƒ¨å±‹ã¸ã®å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ©ã‚¦ãƒ³ã‚¸ã«æˆ»ã‚Šã¾ã™ã€‚');
                window.location.href = '/lounge';
            }
        }, 5000);
        
        // Socket event listeners
        socket.on('joined-room', (data) => {
            console.log('Successfully joined room:', data);
            document.getElementById('roomName').textContent = data.roomName;
        });
        
        socket.on('join-room-error', (data) => {
            console.error('Failed to join room:', data.error);
            alert(`éƒ¨å±‹ã¸ã®å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ${data.error}`);
            window.location.href = '/lounge';
        });
        
        socket.on('connect', () => {
            console.log('Socket connected successfully');
        });
        
        socket.on('disconnect', () => {
            console.log('Socket disconnected');
            alert('ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚');
        });
        
        socket.on('connect_error', (error) => {
            console.error('Socket connection error:', error);
            alert('ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        });
        
        socket.on('room-messages', (messages) => {
            const noMessagesDiv = document.getElementById('noMessages');
            const messagesContainer = document.getElementById('messagesContainer');
            
            if (messages.length > 0) {
                noMessagesDiv.style.display = 'none';
                messages.forEach(message => {
                    // Display all messages in chronological order
                    if (message.type === 'system') {
                        addSystemMessage(message.message);
                    } else {
                        addMessageToUI(message);
                    }
                });
                scrollToBottom();
            }
        });
        
        socket.on('new-message', (message) => {
            console.log('Received new message:', message);
            const noMessagesDiv = document.getElementById('noMessages');
            noMessagesDiv.style.display = 'none';
            
            // Handle both regular messages and system messages
            if (message.type === 'system') {
                console.log(`System message filtering: "${message.username}" !== "${username}" = ${message.username !== username}`);
                // TEMPORARILY DISABLED FILTERING - Show all system messages for debugging
                console.log('ğŸ”§ DEBUG: Showing ALL system messages (filtering disabled)');
                addSystemMessage(message.message);
            } else {
                addMessageToUI(message);
                
                // Play notification sound for messages from other users
                if (message.username !== username) {
                    playNotificationSound();
                }
            }
            
            scrollToBottom();
        });
        
        socket.on('message-error', (data) => {
            console.error('Message sending failed:', data.error);
            alert(`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ${data.error}`);
        });
        
        socket.on('user-joined', (data) => {
            userCount = data.userCount;
            document.getElementById('userCount').textContent = userCount;
            // System message will be handled via 'new-message' event
        });
        
        socket.on('user-left', (data) => {
            userCount = data.userCount;
            document.getElementById('userCount').textContent = userCount;
            // System message will be handled via 'new-message' event
        });
        
        // Typing indicator events
        socket.on('user-typing', (data) => {
            typingUsers.add(data.username);
            updateTypingIndicator();
        });
        
        socket.on('user-stopped-typing', (data) => {
            typingUsers.delete(data.username);
            updateTypingIndicator();
        });
        
        // Message form submission
        document.getElementById('messageForm').addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage();
        });
        
        // Typing detection
        document.getElementById('messageInput').addEventListener('input', () => {
            if (!isTyping) {
                isTyping = true;
                socket.emit('typing', { roomId, username });
            }
            
            // Clear existing timeout
            clearTimeout(typingTimeout);
            
            // Set new timeout to stop typing
            typingTimeout = setTimeout(() => {
                if (isTyping) {
                    isTyping = false;
                    socket.emit('stop-typing', { roomId, username });
                }
            }, 1000); // Stop typing after 1 second of no input
        });
        
        // Function to send message
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message.length === 0) return;
            if (message.length > 500) {
                alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯500æ–‡å­—ä»¥ä¸‹ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // Check socket connection
            if (!socket.connected) {
                alert('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // Stop typing when sending message
            if (isTyping) {
                isTyping = false;
                clearTimeout(typingTimeout);
                socket.emit('stop-typing', { roomId, username });
            }
            
            console.log('Sending message:', { roomId, message, username });
            socket.emit('send-message', { roomId, message, username });
            messageInput.value = '';
        }
        
        // Function to send image message
        async function sendImageMessage(imageBlob, filename = 'pasted-image.png') {
            if (isUploadingImage) {
                return;
            }
            
            isUploadingImage = true;
            
            try {
                // Create FormData for image upload
                const formData = new FormData();
                formData.append('image', imageBlob, filename);
                formData.append('roomId', roomId);
                formData.append('username', username);
                
                // Show uploading indicator
                showUploadingMessage();
                
                // Upload image to server
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                // Hide uploading indicator
                hideUploadingMessage();
                
                if (result.success) {
                    // Send image message through socket
                    const messageData = {
                        roomId,
                        username,
                        message: '', // Empty message for image-only messages
                        imageUrl: result.imageUrl,
                        originalname: result.originalname
                    };
                    
                    console.log('Sending image message:', messageData);
                    socket.emit('send-message', messageData);
                } else {
                    alert(`ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error uploading image:', error);
                hideUploadingMessage();
                alert('ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                isUploadingImage = false;
            }
        }
        
        // Paste event listener for images
        document.addEventListener('paste', async (e) => {
            // Only handle paste in the message input area
            if (document.activeElement !== document.getElementById('messageInput')) {
                return;
            }
            
            const items = e.clipboardData.items;
            
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault(); // Prevent default paste behavior
                    
                    const blob = item.getAsFile();
                    if (blob) {
                        // Check file size (5MB limit)
                        if (blob.size > 5 * 1024 * 1024) {
                            alert('ç”»åƒã®ã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
                            return;
                        }
                        
                        await sendImageMessage(blob, `pasted-${Date.now()}.png`);
                    }
                    break;
                }
            }
        });
        
        // Leave room button
        document.getElementById('leaveRoomBtn').addEventListener('click', () => {
            if (confirm('æœ¬å½“ã«é€€å®¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                socket.emit('leave-room');
                window.location.href = '/lounge';
            }
        });
        
        // Functions
        function addMessageToUI(message) {
            const messagesContainer = document.getElementById('messagesContainer');
            const isOwnMessage = message.username === username;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'}`;
            
            const timestamp = new Date(message.timestamp);
            const timeString = timestamp.toLocaleTimeString('ja-JP', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            let messageContent = '';
            
            if (message.type === 'image' && message.imageUrl) {
                // Image message
                messageContent = `
                    <div class="font-semibold text-sm ${isOwnMessage ? 'text-indigo-100' : 'text-gray-600'} mb-1">
                        ${message.username}
                    </div>
                    <div class="mb-2">
                        <img src="${message.imageUrl}" 
                             alt="${message.originalname || 'ç”»åƒ'}" 
                             class="max-w-full max-h-80 rounded-lg cursor-pointer hover:opacity-90 transition-opacity"
                             onclick="openImageModal('${message.imageUrl}', '${message.originalname || 'ç”»åƒ'}')">
                    </div>
                    ${message.message ? `<div class="break-words">${escapeHtml(message.message)}</div>` : ''}
                    <div class="text-xs ${isOwnMessage ? 'text-indigo-200' : 'text-gray-500'} mt-1 text-right">
                        ${timeString}
                    </div>
                `;
            } else {
                // Text message
                messageContent = `
                    <div class="font-semibold text-sm ${isOwnMessage ? 'text-indigo-100' : 'text-gray-600'} mb-1">
                        ${message.username}
                    </div>
                    <div class="break-words">${escapeHtml(message.message)}</div>
                    <div class="text-xs ${isOwnMessage ? 'text-indigo-200' : 'text-gray-500'} mt-1 text-right">
                        ${timeString}
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="${isOwnMessage 
                    ? 'bg-gradient-to-r from-indigo-500 to-purple-600 text-white' 
                    : 'bg-gray-100 text-gray-800'
                } max-w-xs lg:max-w-md px-4 py-2 rounded-2xl">
                    ${messageContent}
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
        }
        
        function addSystemMessage(message) {
            const messagesContainer = document.getElementById('messagesContainer');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-center';
            
            messageDiv.innerHTML = `
                <div class="bg-yellow-100 text-yellow-800 px-4 py-2 rounded-full text-sm">
                    ${escapeHtml(message)}
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
        }
        
        function scrollToBottom() {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function playNotificationSound() {
            try {
                const notificationSound = document.getElementById('notificationSound');
                if (notificationSound) {
                    // Reset audio to beginning in case it was already playing
                    notificationSound.currentTime = 0;
                    const playPromise = notificationSound.play();
                    
                    // Handle browser autoplay policies
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.log('Could not play notification sound:', error.message);
                        });
                    }
                }
            } catch (error) {
                console.log('Error playing notification sound:', error);
            }
        }
        
        function updateTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            const typingText = document.getElementById('typingText');
            
            if (typingUsers.size === 0) {
                typingIndicator.style.display = 'none';
                return;
            }
            
            const typingArray = Array.from(typingUsers);
            let text = '';
            
            if (typingArray.length === 1) {
                text = `${typingArray[0]}ã•ã‚“ãŒå…¥åŠ›ä¸­...`;
            } else if (typingArray.length === 2) {
                text = `${typingArray[0]}ã•ã‚“ã¨${typingArray[1]}ã•ã‚“ãŒå…¥åŠ›ä¸­...`;
            } else if (typingArray.length === 3) {
                text = `${typingArray[0]}ã•ã‚“ã€${typingArray[1]}ã•ã‚“ã€${typingArray[2]}ã•ã‚“ãŒå…¥åŠ›ä¸­...`;
            } else {
                text = `${typingArray.length}äººãŒå…¥åŠ›ä¸­...`;
            }
            
            typingText.textContent = text;
            typingIndicator.style.display = 'block';
            
            // Scroll to show typing indicator
            scrollToBottom();
        }
        
        // Upload indicator functions
        function showUploadingMessage() {
            const messagesContainer = document.getElementById('messagesContainer');
            const noMessagesDiv = document.getElementById('noMessages');
            noMessagesDiv.style.display = 'none';
            
            const uploadDiv = document.createElement('div');
            uploadDiv.id = 'uploadingIndicator';
            uploadDiv.className = 'flex justify-end';
            
            uploadDiv.innerHTML = `
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white max-w-xs lg:max-w-md px-4 py-2 rounded-2xl opacity-70">
                    <div class="font-semibold text-sm text-indigo-100 mb-1">
                        ${username}
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0ms;"></div>
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 150ms;"></div>
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 300ms;"></div>
                        </div>
                        <span class="text-sm">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</span>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(uploadDiv);
            scrollToBottom();
        }
        
        function hideUploadingMessage() {
            const uploadDiv = document.getElementById('uploadingIndicator');
            if (uploadDiv) {
                uploadDiv.remove();
            }
        }
        
        // Image modal functions
        function openImageModal(imageUrl, imageName) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center';
            modal.style.zIndex = '9999';
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            modal.innerHTML = `
                <div class="max-w-4xl max-h-full p-4 relative">
                    <button onclick="this.closest('.fixed').remove()" 
                            class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-75 transition-all">
                        Ã—
                    </button>
                    <img src="${imageUrl}" 
                         alt="${imageName}" 
                         class="max-w-full max-h-full object-contain rounded-lg">
                    <p class="text-white text-center mt-2">${imageName}</p>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (isTyping) {
                socket.emit('stop-typing', { roomId, username });
            }
            socket.emit('leave-room');
        });
        
        // Focus on message input
        document.getElementById('messageInput').focus();
        
        // Enter key to send message
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html> 